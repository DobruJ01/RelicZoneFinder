<!DOCTYPE html>
<html>
    <head>
        <title>Relic Zone Finder</title>
        <script type="text/javascript" language="javascript" src="//code.jquery.com/jquery-1.11.1.min.js"></script>
        <script src="//crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/md5.js"></script>
	<script type="text/javascript" language="javascript" src="//cdn.datatables.net/1.10.7/js/jquery.dataTables.min.js"></script>
        <link rel="stylesheet" href="//cdn.datatables.net/1.10.7/css/jquery.dataTables.css">
        <script type="text/javascript" src="js/dataTables.colResize.js"></script>
        <style>
            body
            {
                background-color: #222222;
                font-size: 20px;
            }
            .content_bg
            {
                width: 80%;
                background-color: #d3d3d3;
                min-height: 1000px;
                overflow: auto;
                margin: auto;
                padding-left: 10px;
                padding-right: 10px;
                padding-top: 10px;
                padding-bottom: 10px;
            }
            p{
                font-size: 20px;
            }
            .loading{
                background-image: url("img/spinner.gif");
                background-repeat: no-repeat;
                height:200px;
                width:200px;
                margin-left: auto;
                margin-right: auto;
            }
            .tableDiv
            {
                display:none;
            }
            .loading
            {
                display:none;
            }
            .dataTables_wrapper { font-size: 14px }
            .result
            {
                border-collapse: separate;
            }
        </style>
        
    </head>
    <body>

        <div class="content_bg">
            <textarea id="savedata" style="width: 500px; height: 50px" onfocus="this.select()" onmouseup="return false" placeholder="Paste save file here."></textarea>
            <br>Zones to Display: 
            <input type="text" id="numZones" value="5" style="width: 50px" onfocus="this.select()">
            <br>
            <button id="findZone">Generate Items Table</button>
            <button id="createFile">Export Results to File</button>
            <p id="spawnRange">Relic Spawn Range: </p>
            <p id="ascension">Current Ascension: </p>
            <p id="item">Load save file for results.</p>

            <br>
            <div class="tableDiv" id="tableHide">
                <table class="display" id="result" width="100%"></table>
            </div>
            <div class="loading" id="loadHide"></div>
        </div>

<script type="text/javascript">
        var timeout_id = null;
        t = $('#result').DataTable({
            "ordering":true,
            "bPaginate":true,
            "iDisplayLength": 10,
            "searching":true,
            "language":{"emptyTable":"Data is being populated"},
            "processing":true,
            "bScrollCollapse": true,
            "autowidth":false,
            "bInfo" : true,
            "dom": 'Zlfrtip',
            "colResize": {
                "tableWidthFixed": true
            },
            "columns": [
                    { "title": "Ascension", "class": "dt-head-left", "width":"5%"  },
                    { "title": "Spawn Zone", "class": "dt-head-left"},
                    { "title": "Level", "class": "dt-head-left", "width":"5%" },
                    { "title": "Rarity", "class": "dt-head-left", "width":"5%" },
                    { "title": "Ability 1", "class": "dt-head-left" },
                    { "title": "Ability 2", "class": "dt-head-left" },
                    { "title": "Ability 3", "class": "dt-head-left" },
                    { "title": "Ability 4", "class": "dt-head-left" }]
            });
        $('#findZone').on( 'click', function () {
            clearTimeout(timeout_id);
            timeout_id = null;
            t.clear().draw();
            findZones(false);
        } );
        $('#createFile').on( 'click', function () {
            findZones(true);
        } );


function findZones(write_to_file) 
{
    var data = decodeSaveData();
    var start_zones = new Array();
    var results_table;
    if(!data){
        return;
    }
    if(data.numWorldResets == 0){
        alert("You need to ascend before getting relics.");
        return;
    }
    var zone_seed = data.items.bonusZoneRoller.seed;
    var ascension_seed = data.items.ascensionItemsRoller.seed;
    var HZE = data.highestFinishedZonePersist;
    var start_zone = findStartZone(data);
    var spawn_zone = 0;
    var items;
    var num_zones = 1;
    var item_received = JSON.stringify(data.items.gotAscensionItem) != "false" ? true : false;
    var the_worker;
    var worker_data = undefined;
    
    if(isNaN(document.getElementById("numZones").value)){
        num_zones = 5;
    }else{
        num_zones = parseInt(document.getElementById("numZones").value);
    }
    
    if(num_zones <0){
        num_zones = 5;
    }
    if(num_zones > 1500){
        document.getElementById("tableHide").style.display="none";
        document.getElementById("loadHide").style.display="block";
    }
    //web worker for long calculation
    if(the_worker !== undefined){
        the_worker.terminate();
        the_worker = undefined;
    }
    the_worker = new Worker("js/worker.js");
    
    worker_data = {"SZ":start_zone,"HZE":HZE,"zoneSeed":zone_seed,"numZones":num_zones,
                   "ascensionSeed":ascension_seed,"itemReceived":item_received,
                   "ascensions":data.numWorldResets,"writeToFile":write_to_file};
    //start worker
    the_worker.postMessage(worker_data);
    
    //handle response from worker
    the_worker.addEventListener('message', function(event){        
        document.getElementById("loadHide").style.display="none";
        if(write_to_file){
            if(timeout_id !== null){
                document.getElementById("tableHide").style.display="block";
            }
            downloadFile(event.data,num_zones);
        }else{
            document.getElementById("tableHide").style.display="block";
            t.clear().draw();
            timeout_id = setTimeout(function(){
                addRowsToTable(event.data,0,Math.floor(event.data.length/10),0);
            },100);
        }
        the_worker.terminate();
        the_worker = undefined;
    });

    if(JSON.stringify(data.items.gotAscensionItem) != "false"){
        document.getElementById("item").innerHTML = "&#10004; Relic received!"; 
    }else{
        document.getElementById("item").innerHTML = "X Relic not received.";
    }
    document.getElementById("spawnRange").innerHTML = findSpawnRange(start_zone,HZE);
    document.getElementById("ascension").innerHTML = "Current Ascension: " + data.numWorldResets;
    return results_table;
}
function downloadFile(data, num_zones)
{
    var a = document.createElement('a');
            
    csvData = new Blob([data], { type: 'text/csv' }); 
    var csvUrl = URL.createObjectURL(csvData);
    a.href =  csvUrl;
    a.target = '_blank';
    a.download = num_zones + " items" + ".csv";
    document.body.appendChild(a);
    a.click();
}
function addRowsToTable(data,start,updater,total)
{
    var inc = 20;
    var page;
    
    if(start + inc > data.length){
        inc = data.length-start;
    }
    for(var i=start;i<inc+start;i++){
        t.row.add(data[i]);
    }
    if(inc + start < data.length){
        if((start+inc) > total)
        {
            total += updater;
            page = t.page.info().page;
            t.page(page).draw(false);
        }
        timeout_id = setTimeout(function(){
            addRowsToTable(data,start+inc,updater,total);},1);
    }else{
        timeout_id = null;
        t.draw();
    }
}
function findSpawnRange(start, HZE)
{
    var tt;
    var range = "Relic Spawn Range: ";
    tt = Math.ceil(HZE*.66);
    start += 1;
    
    if(tt - start <= Math.ceil(tt*.3)){
        range += start + "-" + (start+Math.ceil(tt*.3));
    }else{
        range += start + "-" + tt;
    }
    return range;
}
function findStartZone(data)
{
    const VISION_RELIC = 6;
    const IRIS = 30;
    var the_item;
    var start_zone = 0;
    //check for items that increase starting zone
    for(var m in data.items.slots){
        if(data.items.slots.hasOwnProperty(m)){
            the_item = data.items.items[data.items.slots[m]];
            for (var j=0; j<4; j++) {
                var str = "bonusType" + j.toString();
                if(the_item[str] == VISION_RELIC) {
                    start_zone += the_item["bonus" + j.toString() + "Level"]
                }
            }
        }
    }
    //check for Iris
    if(data.ancients.ancients.hasOwnProperty(IRIS)) {
        start_zone += data.ancients.ancients[IRIS].level;
    }
    return start_zone;
}
function decodeSaveData() 
{
    var data = $("#savedata").val();
    var TEXT_SPLITTER = "Fe12NAfA3R6z4k0z";
    var SALT = "af0ik392jrmt0nsfdghy0";
    var components = data.split(TEXT_SPLITTER);
    var str = "";

    if (~data.indexOf(TEXT_SPLITTER)) {
        var counter = 0;
        while(counter <components[0].length){
            str += components[0][counter];
            counter += 2;
        }
        if(CryptoJS.MD5(str + SALT) == components[1]){
            return jQuery.parseJSON(atob(str));
        }
    }
    alert("Not a valid save file");
    return;
}
</script>

</body>
</html>