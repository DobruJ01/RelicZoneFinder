<!DOCTYPE html>
<html>
    <head>
        <title>Clicker Heroes Relic Calculator</title>
        <script type="text/javascript" language="javascript" src="//code.jquery.com/jquery-1.11.1.min.js"></script>
        <script src="//crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/md5.js"></script>
	<script type="text/javascript" language="javascript" src="//cdn.datatables.net/1.10.7/js/jquery.dataTables.min.js"></script>
        <link rel="stylesheet" href="//cdn.datatables.net/1.10.7/css/jquery.dataTables.css">
        <link rel='stylesheet' href='CSS/generalstylesheet.css'>
        <script type="text/javascript" src="js/dataTables.colResize.js"></script>
        <script type="text/javascript" src='js/SpinBox.js'></script>    
        <link rel="stylesheet" href="CSS/stylesheet.css">
    </head>
    <body>
        <div class="bg">
            <div class='title'>Relic Calculator</div>
            <div class="content_bg">
                <div class="top">
                    <div class="input">
                        <textarea id="savedata" style="width: 500px; height: 50px" onfocus="this.select()" onmouseup="return false" placeholder="Paste save file here."></textarea>
                        <table id="spinboxes" style="cell-padding:2">
                            <tr>
                                <td>Zones to Display:</td>
                                <td><span id="sbNumZones"></span></td>
                            </tr>
                            <tr>
                                <td>Relics to Buy First:</td>
                                <td><span id="sbRubyRelic"></span></td>
                                <td>
                                    <span class="dropt"><img src='img/info.png'>
                                        <span style="width:250px;">
                                        Purchasing relics with rubies can offset the seed by three and generate a completely different string of items. Adjust this value to see what would happen if you bought relics with rubies.</span>
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td>Ascensions:</td>
                                <td><span id="sbAscension"></span></td>
                                <td>
                                    <span class="dropt"><img src='img/info.png'>
                                        <span style="width:250px;">
                                        Ascending without receiving a relic will make the spawn zone of the next item move to the current item. Adjust this value to see how ascending can affect the items.</span>
                                    </span>
                                </td>
                            </tr>
                        </table>
                        <br>
                        <button class="button" id="findZone">Generate Table</button>
                        <button class="button" id="createFile">Generate File</button>
                    </div>
                    <div class="stats">
                        <div class='statsData' id='statsData'>
                            <div class="info" id="spawnRange"></div>
                            <div class="info" id="ascension"></div>
                            <div id='baba'>
                                <span id='receivedImage'><img src='' id='ri'></span>
                                <div class="info" id="item"></div>
                            </div>
                            <div class="loadSave">[Load save for results]</div>
                            
                        </div>
                        <div class="loading" id="loadHide"></div>
                    </div>
                    
                </div>
                <div class='spacer'></div>
                <div class="tableDiv" id="tableHide">
                    <table class="display" id="result" width="100%"></table>
                </div>
                <br>
                <br>
                <div id='disclaimer'> Notes: <br>
                    - Update: Rarity now sorts on rarity value instead of alphabetically. <br>
                    - New features have been tested and seem to be working as intended. If you find a bug, please report it. You can find me on <a href="https://www.reddit.com/r/ClickerHeroes/comments/3ki9mf/relic_calculator/" target="_blank">this</a> thread.<br>
                    - Special thanks to /u/Kaj_ for pointing out a very subtle bug.<br>
                    - If your dream relic has suddenly changed, increase the level by one to get it back <br>
                    - Last updated 9/15/2015
                </div>
            </div>
        </div>

<script type="text/javascript">
        var timeout_id = null;
        var sb_ruby_relic = new SpinBox(document.getElementById('sbRubyRelic'),{"step":3,"minimum":0});
        var sb_num_zones = new SpinBox(document.getElementById('sbNumZones'),{"value":25,"step":25,"minimum":1});
        var sb_ascensions = new SpinBox(document.getElementById('sbAscension'),{"step":1,"minimum":0});
        t = $('#result').DataTable({
            "ordering":true,
            "bPaginate":true,
            "iDisplayLength": 10,
            "searching":true,
            "processing":true,
            "bScrollCollapse": true,
            "autowidth":false,
            "bInfo" : true,
            "dom": 'Zlfrtip',
            "colResize": {
                "tableWidthFixed": true
            },
            "columns": [
                    { "title": "Ascension", "class": "dt-head-left", "width":"5%"  },
                    { "title": "Spawn Zone", "class": "dt-head-left","width":"10%"},
                    { "title": "Level", "class": "dt-head-left", "width":"5%" },
                    { "title": "Rarity", "class": "dt-head-left", "width":"5%","iDataSort":8 },
                    { "title": "Ability 1", "class": "dt-head-left", "width":"18%" },
                    { "title": "Ability 2", "class": "dt-head-left", "width":"18%" },
                    { "title": "Ability 3", "class": "dt-head-left", "width":"18%" },
                    { "title": "Ability 4", "class": "dt-head-left", "width":"18%" },
                    { "title": "rarity_num", "bVisible":false }],
            });
        $('#findZone').on( 'click', function () {
            clearTimeout(timeout_id);
            timeout_id = null;
            t.clear().draw();
            findZones(false);
        } );
        $('#createFile').on( 'click', function () {
            findZones(true);
        } );


function findZones(write_to_file) 
{
    var data = decodeSaveData();
    var start_zones = new Array();
    var results_table;
    if(!data){
        return;
    }
    if(data.numWorldResets == 0){
        alert("You need to ascend before getting relics.");
        return;
    }

    var zone_seed = data.items.bonusZoneRoller.seed;
    var ascension_seed = data.items.ascensionItemsRoller.seed;
    var HZE = data.highestFinishedZonePersist;
    var start_zone = findStartZone(data);
    var spawn_zone = 0;
    var items;
    var num_zones = 1;
    var item_received = JSON.stringify(data.items.gotAscensionItem) != "false" ? true : false;
    var the_worker;
    var worker_data = undefined;
    
    num_zones = sb_num_zones.getValue();

    //Remove initial load data message
    if(document.getElementsByClassName("loadSave")[0] !== undefined){
        document.getElementsByClassName("loadSave")[0].parentNode.removeChild(document.getElementsByClassName("loadSave")[0]);
    }
    
    if(num_zones > 1500){
        document.getElementById("statsData").style.display="none";
        document.getElementById("loadHide").style.display="block";
    }
    
    //Ensure relics are purchased in multiples of 3
    if(sb_ruby_relic.getValue()%3 !==0)
        sb_ruby_relic.setValue(sb_ruby_relic.getValue() + (3-sb_ruby_relic.getValue()%3))
    
    //web worker for long calculation
    if(the_worker !== undefined){
        the_worker.terminate();
        the_worker = undefined;
    }
    the_worker = new Worker("js/worker.js");
    
    worker_data = {"SZ":start_zone,"HZE":HZE,"zoneSeed":zone_seed,"numZones":num_zones,
                   "ascensionSeed":ascension_seed,"itemReceived":item_received,
                   "ascensions":data.numWorldResets,"writeToFile":write_to_file,
                   "rubyRelic":sb_ruby_relic.getValue(),"ascensionsFirst":sb_ascensions.getValue(),
                   "highestLevelItem":getHighestLevelItem(data)};
    
    //start worker
    the_worker.postMessage(worker_data);
    
    //handle response from worker
    the_worker.addEventListener('message', function(event){        
        document.getElementById("loadHide").style.display="none";
        if(write_to_file){
            if(t.data().length > 0){
                document.getElementById("statsData").style.display="block";
            }
            downloadFile(event.data,num_zones);
        }else{
            document.getElementById("statsData").style.display="block";
            t.clear().draw();
            timeout_id = setTimeout(function(){
                addRowsToTable(event.data,0);
            },100);
        }
        the_worker.terminate();
        the_worker = undefined;
    });

    if(!write_to_file){
        document.getElementById("receivedImage").style.display="block";
        if(JSON.stringify(data.items.gotAscensionItem) != "false"){
            document.getElementById("ri").src = "img/relic received.png";
            document.getElementById("item").innerHTML = "Relic received!";
        }else{
            document.getElementById("ri").src = "img/no relic.png";
            document.getElementById("item").innerHTML = "Relic not received.";
        }
        document.getElementById("spawnRange").innerHTML = findSpawnRange(start_zone,HZE);
        document.getElementById("ascension").innerHTML = "Current Ascension: " + data.numWorldResets;
    }
}
function downloadFile(data, num_zones)
{
    var a = document.createElement('a');
            
    csvData = new Blob([data], { type: 'text/csv' }); 
    var csvUrl = URL.createObjectURL(csvData);
    a.href =  csvUrl;
    a.target = '_blank';
    a.download = num_zones + " items" + ".csv";
    document.body.appendChild(a);
    a.click();
}
function addRowsToTable(data,start)
{
    var inc = 20;
    var page;
    
    if(start + inc > data.length){
        inc = data.length-start;
    }
    for(var i=start;i<inc+start;i++){
        t.row.add(data[i]);
    }
    if(inc + start < data.length){
        if(t.page.info().page == t.page.info().pages-1 || start == 0)
        {
            page = t.page.info().page;
            t.draw();
            t.page(page).draw(false);
        }
        timeout_id = setTimeout(function(){
            addRowsToTable(data,start+inc);},1);
    }else{
        timeout_id = null;
        t.draw();
    }
}
function findSpawnRange(start, HZE)
{
    var tt;
    var range = "Spawn Range: ";
    tt = Math.ceil(HZE*.66);
    start += 1;
    
    if(tt - start <= Math.ceil(tt*.3)){
        range += start + "-" + (start+Math.ceil(tt*.3));
    }else{
        range += start + "-" + tt;
    }
    return range;
}
function getHighestLevelItem(data)
{
    var highest = 0;
    
    for(var m in data.items.slots){
        if(data.items.slots.hasOwnProperty(m)){
            level = data.items.items[data.items.slots[m]].level;
            if(level > highest){
                highest = level;
            }
        }
    }
    return highest;
}
function findStartZone(data)
{
    const VISION_RELIC = 6;
    const IRIS = 30;
    var the_item;
    var start_zone = 0;
    //check for items that increase starting zone
    for(var m in data.items.slots){
        if(data.items.slots.hasOwnProperty(m)){
            the_item = data.items.items[data.items.slots[m]];
            for (var j=0; j<4; j++) {
                var str = "bonusType" + j.toString();
                if(the_item[str] == VISION_RELIC) {
                    start_zone += the_item["bonus" + j.toString() + "Level"]
                }
            }
        }
    }
    //check for Iris
    if(data.ancients.ancients.hasOwnProperty(IRIS)) {
        start_zone += data.ancients.ancients[IRIS].level;
    }
    return start_zone;
}
function decodeSaveData() 
{
    var data = $("#savedata").val();
    var TEXT_SPLITTER = "Fe12NAfA3R6z4k0z";
    var SALT = "af0ik392jrmt0nsfdghy0";
    var components = data.split(TEXT_SPLITTER);
    var str = "";
    
    if(data.charAt(0) == '{'){
        var parsed_data = "";
        try
        {
            parsed_data = $.parseJSON(data);
        }catch(Exception){alert("Invalid Format");}
        
        return parsed_data;
    }
    if (~data.indexOf(TEXT_SPLITTER)) {
        var counter = 0;
        while(counter <components[0].length){
            str += components[0][counter];
            counter += 2;
        }
        if(CryptoJS.MD5(str + SALT) == components[1]){
            return $.parseJSON(atob(str));
        }
    }
    alert("Not a valid save file");
    return;
}
</script>

</body>
</html>