<!DOCTYPE html>
<html>
    <head>
        <title>Relic Zone Finder</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://cdn.datatables.net/1.10.7/css/jquery.dataTables.css">
        <script type="text/javascript" language="javascript" src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
        <script src="https://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/md5.js"></script>
        
        
        
        <script type="text/javascript" src="/media/js/site.js?_=207805c784725de7bada944126dbaa67"></script>
	<script type="text/javascript" src="/media/js/dynamic.php?comments-page=examples%2Fdata_sources%2Fjs_array.html" async=""></script>
	
	<script type="text/javascript" language="javascript" src="https://cdn.datatables.net/1.10.7/js/jquery.dataTables.min.js"></script>
<!--	<script type="text/javascript" language="javascript" src="../resources/demo.js"></script>-->
        <script type="text/javascript" class="init"></script> 
        <style>
            body
            {
                background-color: #222222;//#FFFFE0;
                font-size: 20px;
                //height: 800px;
                //overflow: auto;
            }
            .content_bg
            {
                //height: 80px;
                width: 980px;
                background-color: #d3d3d3;
                //opacity: 0.5;
                min-height: 1000px;
                overflow: auto;
                margin: auto;
                padding-left: 10px;
                padding-right: 10px;
            }
            #content
            {
                width:800px;
                margin:auto; 
                height: 800px; 
                //background:#fff; 
                //overflow:auto;
}
            p{
                font-size: 20px;
            }
            .dataTables_wrapper { font-size: 20px }

        </style>
        
    </head>
    <body>

        <div class="content_bg">
<!--            <div id="content">-->
                <textarea id="savedata" style="width: 500px; height: 50px" onfocus="this.select()" onmouseup="return false" placeholder="Paste save file here."></textarea>
                <br>Zones to Display: 
                <input type="text" id="numZones" value="5" style="width: 50px" onfocus="this.select()">
                <br>
                <button id="findZone">Find Relic Zone</button>
                <p id="spawnRange">Relic Spawn Range: </p>
                <p id="item">Load save file for results.</p>

                <br>
                <table cellpadding="0" cellspacing="0" border="0" class="display" id="result" width="100%">
                    <!--<thead>
                        <tr>
                            <th>Ascension</th>
                            <th>Spawn Zone</th>
                            <th>Relic Level</th>
                        </tr>
                    </thead>-->
                </table>
<!--            </div>-->
        </div>

<script>

    $(document).ready(function() {
        var t = $('#result').DataTable({
            "ordering":false,
            "bPaginate":false,
            "searching":false,
            "bInfo" : false,
            "columns": [
                    { "title": "Ascension", "class": "dt-head-left"  },
                    { "title": "Spawn Zone", "class": "dt-head-left" },
                    { "title": "Relic Level", "class": "dt-head-left" }]
            });

        $('#findZone').on( 'click', function () {
            t.clear();
            var the_data = findZones();
            t.rows.add(the_data).draw();

            counter++;
        } );
    } );

function findZones() 
{
    var data = decodeSaveData();
    var start_zones = new Array();
    var results_table;
    if(!data){
        return;
    }
    if(data.numWorldResets == 0){
        alert("You need to ascend before getting relics.");
        return;
    }
    
    var zone_seed = data.items.bonusZoneRoller.seed;
    var HZE = data.highestFinishedZonePersist;
    var start_zone = findStartZone(data);
    var spawn_zone = 0;
    
    var num_zones = 1;
    if(isNaN(document.getElementById("numZones").value)){
        num_zones = 5;
    }else{
        num_zones = parseInt(document.getElementById("numZones").value);
    }
    
    if(num_zones <0){
        num_zones = 5;
    }
    zones = findSeveralStartZones(start_zone,HZE,zone_seed,num_zones);
    results_table = createTable(data.numWorldResets,zones);
    
    if(JSON.stringify(data.items.gotAscensionItem) != "false"){
        document.getElementById("item").innerHTML = "&#10004; Relic received!"; 
    }else{
        document.getElementById("item").innerHTML = "X Relic not received.";
    }
    document.getElementById("spawnRange").innerHTML = findSpawnRange(start_zone,HZE);
    
    return results_table;
}
function findSpawnRange(start, HZE)
{
    var tt;
    var range = "Relic Spawn Range: ";
    tt = Math.ceil(HZE*.66);
    start += 1;
    
    if(tt - start <= Math.ceil(tt*.3)){
        range += start + "-" + (start+Math.ceil(tt*.3));
    }else{
        range += start + "-" + tt;
    }
    return range;
}
function createTable(counter, data)
{
    var dataset = [];
    
    for (var i=0; i<data.length; i++) {
        dataset.push([i+counter,data[i],Math.ceil(Math.max(50*(1-Math.pow(1.2,(-data[i]/100+1))),1))])
    }
    if(dataset.length > 0){
        dataset[0][0] = "Current";
    }
    return dataset;
}
function findSeveralStartZones(start, HZE, s, num)
{
    var zones = new Array();
    var previous_seed = 0;
    for(var i=0;i<num;i++) {
        zones[i] = getBonusItemZone(start, HZE, s);
        s = randNum(randNum(randNum(randNum(s))));
        
    }
    return zones;
}
function findStartZone(data)
{
    const VISION_RELIC = 6;
    const IRIS = 30;
    var the_item;
    var start_zone = 0;
    //check for items that increase starting zone
    for(var m in data.items.slots){
        if(data.items.slots.hasOwnProperty(m)){
            the_item = data.items.items[data.items.slots[m]];
            for (var j=0; j<4; j++) {
                var str = "bonusType" + j.toString();
                if(the_item[str] == VISION_RELIC) {
                    start_zone += the_item["bonus" + j.toString() + "Level"]
                }
            }
        }
    }
    //check for Iris
    if(data.ancients.ancients.hasOwnProperty(IRIS)) {
        start_zone += data.ancients.ancients[IRIS].level;
    }
    return start_zone;
}
function decodeSaveData() 
{
    var data = $("#savedata").val();
    var TEXT_SPLITTER = "Fe12NAfA3R6z4k0z";
    var SALT = "af0ik392jrmt0nsfdghy0";
    var components = data.split(TEXT_SPLITTER);
    var str = "";

    if (~data.indexOf(TEXT_SPLITTER)) {
        var counter = 0;
        while(counter <components[0].length){
            str += components[0][counter];
            counter += 2;
        }
        if(CryptoJS.MD5(str + SALT) == components[1]){
            return jQuery.parseJSON(atob(str));
        }
    }
    alert("Not a valid save file");
    return;
}
function getBonusItemZone(start, HZE, s)
{
    var tt = 0;
    var seed = 0;
    var zone = 0;
    seed = s;
    tt = Math.ceil(HZE * 0.66);
    
    if (tt - start <= Math.ceil(tt * 0.3)) {
       tt = start + Math.ceil(tt * 0.3);
    }
    start = Math.max(99, start);
    tt = Math.max(101, tt);
    do {
        seed = randNum(seed);
        zone = range(start, tt, seed);
    }while (zone % 5 == 0);
    
    return zone;

}
function range(start, finish, seed)
{
    return seed % (finish - start + 1) + start;
}
function randNum(seed) 
{
    return (seed * 16807) % (2147483647);
}

</script>

</body>
</html>