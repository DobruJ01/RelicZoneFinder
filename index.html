<!DOCTYPE html>
<html>
    <head>
        <title>Relic Zone Finder</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
        <script src="https://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/md5.js"></script>
        <textarea id="savedata" style="width: 500px; height: 100px" onfocus="this.select()" onmouseup="return false" placeholder="Paste save file here."></textarea>
        <br>Zones to Display: 
        <input type="text" id="numZones" value="5" style="width: 50px" onfocus="this.select()">
        <br>
        <button onclick="main()">Find Relic Zone</button>
        <p id="spawnRange"></p>
        <p id="item"></p>
        <div id="divResults"></div>
        <p id="result"></p>
        

<script>

function main() {
    clearResults();
    var data = decodeSaveData();
    var start_zones = new Array();
    if(!data){
        return;
    }
    if(data.numWorldResets == 0){
        alert("You need to ascend before getting relics.");
        return;
    }
    
    var zone_seed = data.items.bonusZoneRoller.seed;
    var HZE = data.highestFinishedZonePersist;
    var start_zone = findStartZone(data);
    var spawn_zone = 0;
    var results_table;
    var num_zones = 1;
    if(!parseInt(document.getElementById("numZones").value)){
        num_zones = 5;
    }else{
        num_zones = parseInt(document.getElementById("numZones").value);
    }
    
    if(num_zones <0){
        num_zones = 5;
    }
    spawn_zone = getBonusItemZone(start_zone,HZE,zone_seed);
    //alert(document.getElementById("numZones").value);
    zones = findSeveralStartZones(start_zone,HZE,zone_seed,num_zones);
    results_table = createTable(data.numWorldResets,zones);
    if(JSON.stringify(data.items.gotAscensionItem) != "false"){
        document.getElementById("item").innerHTML = "According to the save file, you've already received your relic for this ascension."; 
    }else{
        document.getElementById("item").innerHTML = "According to the save file, you have NOT received your relic for this ascension.";
    }
    $('#divResults').append(results_table);
    document.getElementById("spawnRange").innerHTML = findSpawnRange(start_zone,HZE);
    //document.getElementById("result").innerHTML = "Start Zone: " + (start_zone+1) + "<br>"
    //                                            + "Highest Zone: " + HZE + "<br>"
    //                                            + "Relic Spawn Zone: " + spawn_zone + "<br>";
}
function findSpawnRange(start, HZE)
{
    var tt;
    var range = "Relic spawn range: ";
    tt = Math.ceil(HZE*.66);
    start += 1;
    
    if(tt - start <= Math.ceil(tt*.3)){
        range += start + "-" + (start+Math.ceil(tt*.3));
    }else{
        range += start + "-" + tt;
    }
    return range;
}
function clearResults()
{
    document.getElementById("spawnRange").innerHTML = "";
    document.getElementById("item").innerHTML = ""; 
    $('#divResults').empty();
    document.getElementById("result").innerHTML = "";
}
function createTable(counter, data)
{
    var r = "<table><tr><td style='width: 100px; color: red;'>Ascension</td>";
    var level = 0;
    r += "<td style='width: 100px; color: red; text-align: right;'>Spawn Zone</td>";
    r +="<td style='width: 100px; color: red; text-align: right;'>Relic Level</td></tr>";

    r+="<tr><td style='width: 100px;                   '>---------------</td>";
    r+="<td     style='width: 100px; text-align: right;'>---------------</td>";
    r+="<td     style='width: 100px; text-align: right;'>---------------</td></tr>";

    for (var i=0; i<data.length; i++) {
        if(i==0){
            r+="<tr><td style='width: 100px;'>" + "Current" + "</td>";
        }else{
            r+="<tr><td style='width: 100px;'>" + (i+counter) + "</td>";
        }
        //r+="<tr><td style='width: 100px;'>" + (i+counter) + "</td>";
        //alert(data[i]);
        //data[i] = data[i].toFixed(2);
        r+="<td style='width: 100px; text-align: right;'>" + data[i] + "</td>";
        
        level = Math.ceil(Math.max(50*(1-Math.pow(1.2,(-data[i]/100+1))),1)); //Math.max(Math.ceil(()),1),1)
        r+="<td style='width: 100px; text-align: right;'>" + level + "</td></tr>";
    }  
    r+="</table>";

    return r;
}
function findSeveralStartZones(start, HZE, s, num)
{
    var zones = new Array();
    for(var i=0;i<num;i++) {
        zones[i] = getBonusItemZone(start, HZE, s);
        s = randNum(randNum(randNum(randNum(s))));
    }
    return zones;
}
function findStartZone(data)
{
    const VISION_RELIC = 6;
    const IRIS = 30;
    var the_item;
    var start_zone = 0;
    //check for items that increase starting zone
    for(var i=0;i<4;i++){
        if(data.items.slots[i+1]){
            the_item = data.items.items[data.items.slots[i+1]];
            for (var j=0; j<4; j++) {
                var str = "bonusType" + j.toString();
                if(the_item[str] == VISION_RELIC) {
                    start_zone += the_item["bonus" + j.toString() + "Level"]
                }
            }
        }
    }
    //check for Iris
    if(data.ancients.ancients[IRIS].level) {
        start_zone += data.ancients.ancients[IRIS].level;
    }
    return start_zone;
}
function decodeSaveData() 
{
//Decode function taken from Rivsoft (http://s3-us-west-2.amazonaws.com/clickerheroes/ancientssoul.html)
    const ANTI_CHEAT_CODE = "Fe12NAfA3R6z4k0z";
    const SALT = "af0ik392jrmt0nsfdghy0";
    var txt = $("#savedata").val();

    if (txt.search(ANTI_CHEAT_CODE) != -1) {
        var result = txt.split(ANTI_CHEAT_CODE);
        txt = "";
        for (var i = 0; i < result[0].length; i += 2) {
            txt += result[0][i];
        }
        if (CryptoJS.MD5(txt + SALT) != result[1]) {
            alert("Invalid Save File");
            return;
        }
    }
    return jQuery.parseJSON(atob(txt));
}
function getBonusItemZone(start, HZE, s)
{
    var tt = 0;
    var seed = 0;
    var zone = 0;
    seed = s;
    tt = Math.ceil(HZE * 0.66);
    
    if (tt - start <= Math.ceil(tt * 0.3)) {
       tt = start + Math.ceil(tt * 0.3);
    }
    start = Math.max(99, start);
    tt = Math.max(101, tt);
    do {
        seed = randNum(seed);
        zone = range(start, tt, seed);
    }while (zone % 5 == 0);
    
    return zone;

}
function range(start, finish, seed)
{
    return seed % (finish - start + 1) + start;
}
function weightedChoice(choices, s)
{
    var weights = 0;
    var ran_num = 0;
    var seed = s;
    var counter = 0;
    var total = 0;
    
    for(var i=0; i< choices.length;i++){
        weights += choices[i];
    }
    seed = randNum(seed);
    ran_num = seed % (weights + 1);
    while (ran_num >= 0){
        ran_num -= choices[counter];
        counter++;
    }
}
function randNum(seed) 
{
    return (seed * 16807) % (2147483647);
}
</script>
</body>
</html>
